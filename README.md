# Python Reputation System

Evaluate and compare reputation systems & their improvement methods in Python

## Repository Directory Structure
```
├───thesis
├───legacy_repsys
└───pyrepsys                                # pyrepsys project dir
    ├───pyrepsys                            # source files
    ├───pyrepsys-cli.py                     # CLI for calling from terminal
    ├───example_run_params.yaml
    ├───scenarios                           # scenarios for simulation purposes
    │   ├───example_generator.yaml
    │   ├───example_scenario_defaults.yaml
    │   ├───example_scenario_1.yaml
    │   ├───example_scenario_1_noage.yaml
    │   ├───...
    ├───simulation_artifacts                # results of simulations, not cleared by pyrepsys
    │   ├───run_2021-06-15_15:12:46
    │   ├───run_2021-06-15_15:15:25
    │   ├───...
    └───tests                               # all things testing
        ├───runparams_for_tests             # testing runparams for easier calling
        ├───scenarios_for_tests             # scenarios for testing purposes
        │   ├───test_scenario_defaults.yaml
        │   ├───test_scenario_1.yaml
        │   ├───...
        ├───simulation_artifacts_from_tests # results of test simulations, cleared before tests
```

## Usage

### Installation

1. Clone the repository

    ```bash
    git clone https://gitlab.lrz.de/tum-ei-esi/group-consensus/reputation-system.git
    ```

2. Install dependencies

    ```bash
    pip install -U pyyaml pytest matplotlib
    ```

### Command Line Interface

Call pyrepsys from terminal through `pyrepsys-cli.py`. Give subcommands and a number of arguments to run a simulation, tests, or create scenarios.

In order to use the CLI, go to the pyrepsys project directory. This is  where `pyrepsys-cli.py` is located.

```bash
cd reputation-system/pyrepsys
```

If you need help, use the `-h` switch with any subcommand.

#### Starting Simulation
Simulation is started with the `simulate` subcommand. The shorter `s` or `sim` are also available as aliases.

```bash
python3 pyrepsys-cli.py simulate -rp RUNPARAMS
python3 pyrepsys-cli.py simulate -s SCENARIO [SCENARIO ...] -d DEFAULT_SCENARIO
```

There are two ways to tell pyrepsys which scenarios to simulate.

1. Use a runparams file. List all the scenarios and the defaults you need in a YAML file. Place it in the same directory as `pyrepsys-cli.py`. 

    An example runparams file named run_params.yaml could look like:
    
    ```yaml
    scenario_defaults: "my_scenario_defaults.yaml"
    scenarios:
    - "scenario.yaml"
    - "alt_scenario.yaml"
    - "third_scenario.yaml"
    ```
    
    Call a simulation with this runparams file:
    
    ```bash
    python3 pyrepsys-cli.py simulate -rp run_params.yaml
    ```
2. List scenarios and the defaults directly in the command line as arguments. E.g. to achieve the same as in the above example, type:

    ```bash
    python3 pyrepsys-cli.py simulate -s scenario.yaml alt_scenario.yaml third_scenario.yaml -d my_scenario_defaults.yaml
    ```

#### Scenario Creator
The scenario creator is used to generate a batch of scenarios automatically. Generation is based on a generator file containing possible variations of scenario parameters. The creator generates scenarios with all possible combinations of the parameter variations. Optionally, a runparams file is also created with the generated scenarios.

Use the subcommand `scenario-creator` or `sc`. Specify the generator file. Optionally give a runparams filename to fill it with the generated scenarios. If a scenario defaults is also given, it is included in the runparams file. The `-c` or `--clean` flag cleans all scenarios previously generated by the scenario creator.

```bash
python3 pyrepsys-cli.py sc [-c] -g GENERATOR [-rp RUNPARAMS] [-d DEFAULT_SCENARIO]
python3 pyrepsys-cli.py sc --clean
```

The generator file must be located in the `scenarios` directory. An example generator file named generator.yaml could look like:

```yaml
reputation_strategy: 
  - "RepStrat_1"
  - "RepStrat_2"
  - "RepStrat_3"
improvement_handlers:
  - ["Improvement_A", "Improvement_B", "Improvement_C"]
  - ["Improvement_A", "Improvement_D"]
```

Created scenarios are saved to the `scenarios` directory with a name like `sc_{combination ID}.yaml` The combination ID encodes which variant was used for each parameter in the given scenario. Zero-based numbering is used.

For example, the above generator file has two parameters with 3 and 2 variants respectively. This gives a total of 6 combinations. Combination IDs will take the form of `[0..2]-[0..1]`. The scenarios generated:

```yaml
# contents of sc_0-0.yaml:
reputation_strategy: "RepStrat_1"
improvement_handlers: ["Improvement_A", "Improvement_B", "Improvement_C"]

# contents of sc_0-1.yaml:
reputation_strategy: "RepStrat_1"
improvement_handlers: ["Improvement_A", "Improvement_D"]

# contents of sc_1-0.yaml:
reputation_strategy: "RepStrat_2"
improvement_handlers: ["Improvement_A", "Improvement_B", "Improvement_C"]

[... two other scenarios omitted ...]

# contents of sc_2-1.yaml:
reputation_strategy: "RepStrat_3"
improvement_handlers: ["Improvement_A", "Improvement_D"]
```

#### Starting Tests
To run all the tests, give the `test` or `t` subcommand. The `-v` flag increases pytest verbosity. 

```bash
python3 pyrepsys-cli.py test [-h] [-v] [-m MARKEXPR]
```

When not all tests are needed, select which tests to run with the `-m` or `--markexpr` flag. Certain tests are decorated with markers. An expression string using `not`, `and`, `or` and the marker name can select or deselect these tests. Supported marks are listed in `tests/pytest.ini`. For example, to run performance-related tests that are not long:

```bash
python3 pyrepsys-cli.py t -m "perf and not long"
```


### Programmatic Calling

## Reputation Methods
### Adding Reputation Methods
### Adding Improvement Methods

## Scenarios
### Adding Scenarios

## Metrics
### Adding Metrics

## Testing
### Adding Tests